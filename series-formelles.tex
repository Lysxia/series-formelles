%% -*- mode: LaTeX; compile-command: "mk" -*-
\documentclass{amsart}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Packages

\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{amssymb}
\usepackage{stmaryrd}
\usepackage[all]{xy}
\usepackage{prettyref}
\usepackage{mdframed}
\usepackage{todonotes}
\usepackage{xspace}
\usepackage{url}
\usepackage{xcolor}
\usepackage{soul}

\usepackage[backend=pgf,extension=pgf,input,outputdir=diagrams]{diagrams-latex}

\usepackage[authoryear]{natbib}
\usepackage{bibentry}
\nobibliography*

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Theorem-like environments

\newtheorem{thm}{Theorem}[section]
\newtheorem{prop}[thm]{Proposition}
\newtheorem{lem}[thm]{Lemma}
\newtheorem{cor}[thm]{Corollary}
\newtheorem{conj}[thm]{Conjecture}

\theoremstyle{definition}

\newtheorem{defn}[thm]{Definition}
\newtheorem{ex}{Example}

\theoremstyle{remark}
\newtheorem*{rem}{Remark}
\newtheorem*{nota}{Notation}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Commentary environment

\newmdenv[skipabove=1em, skipbelow=1em, innermargin=1.5em, outermargin=1.5em, backgroundcolor=black!10, linecolor=black!10]{commentary}

%% XXX use a different font for commentary?  Or a different font for
%% original paper?

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Translation

\colorlet{lightpurple}{purple!15}
\sethlcolor{lightpurple}
\newcommand{\trans}[2]{\hl{#1 [\textit{#2}]}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Todo notes

\presetkeys{todonotes}{backgroundcolor=yellow!20!white,inline}{}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Math formatting

\newcommand{\B}{\mathbb{B}}
\newcommand{\E}{\mathbb{E}}
\newcommand{\Z}{\mathbb{Z}}
\newcommand{\N}{\mathbb{N}}
\DeclareMathOperator{\el}{el}
\DeclareMathOperator{\Res}{Res}

\newcommand{\bij}{\stackrel{\sim}{\rightarrow}}
\newcommand{\inj}{\hookrightarrow}

\DeclareMathOperator{\Card}{Card}
\DeclareMathOperator{\Aut}{Aut}
\newcommand{\Mon}{\mathrm{Mon}}
\newcommand{\unl}[1]{\tilde{#1}}

\newcommand{\term}[1]{\emph{#1}}

\newcommand{\union}{\cup}
\newcommand{\intersect}{\cap}

\newcommand{\pointed}[1]{#1^{\bullet}}
\newcommand{\Gc}{\pointed{G_c}}
\newcommand{\Gcc}{\pointed{G_{cc}}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Prettyref

\newcommand{\Sect}{\S}

\newrefformat{fig}{Figure~\ref{#1}}
\newrefformat{chap}{Chapter~\ref{#1}}
\newrefformat{sec}{\Sect\ref{#1}}
\newrefformat{eq}{equation~\eqref{#1}}
\newrefformat{prob}{Problem~\ref{#1}}
\newrefformat{tab}{Table~\ref{#1}}
\newrefformat{thm}{Theorem~\ref{#1}}
\newrefformat{lem}{Lemma~\ref{#1}}
\newrefformat{prop}{Proposition~\ref{#1}}
\newrefformat{defn}{Definition~\ref{#1}}
\newrefformat{cor}{Corollary~\ref{#1}}
\newrefformat{conj}{Conjecture~\ref{#1}}
\newrefformat{ex}{Example~\ref{#1}}

\newcommand{\pref}[1]{\prettyref{#1}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Other formatting

\setcounter{figure}{-1}

\newcommand{\etc}{\textit{etc.}\xspace}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{document}

\begin{center}
  {\textbf{A COMBINATORIAL THEORY OF FORMAL SERIES}}
  \bigskip

  {\small ANDR\'E JOYAL} \bigskip

  {\small Translation and commentary by \\
    BRENT A. YORGEY}
  \vspace{0.5in}

  {\small \textbf{This is an unofficial translation of an article
       that appeared in an Elsevier publication. Elsevier has not
       endorsed this translation.} \medskip

     See \url{http://www.elsevier.com/about/open-access/open-access-policies/oa-license-policy/elsevier-user-license}.
  } \bigskip

  {\small \bibentry{joyal1981theorie}} \vspace{0.5in}

\end{center}

\section*{Preface}

\todo{Write a preface explaining the motivation, format of the
  commentary, and so on.  Things to mention: classic work. Worthwhile
  read, even given subsequent developments like BLL. Even I learned
  new things and new perspectives from reading it.  Theory of species
  opens up relationships between combinatorics and CS, algebraic data
  types etc.

  Inaccessible to many because of (1) language, (2) audience.  (1)
  easily enough addressed.  Have updated diagrams etc., typeset
  everything in LaTeX as well. As for (2), originally written for
  mathematicians. I've added commentary with additional explanation
  and examples.  Especially concerned to make it accessible to those
  in the CS world.  Show how commentary is typeset.

  Contribution/collaboration welcome.  Could particularly use help
  with translation; I don't actually know any French.  Explain my
  philosophy in translating: italics, etc. Add link to
  original. Contributions to commentary are also welcome.  Helpful
  even just to read and say which parts you find particularly hard to
  understand, so I know to add some commentary.}

\newpage

\title{A combinatorial theory of formal series}
\author{Andr\'e Joyal}
\address{Department of Mathematics, University of Quebec Montreal \\
Montreal, Quebec H30 3P8, Canada}
\translator{Brent A. Yorgey}
\address{Department of Mathematics and Computer Science \\ Hendrix
  College \\ 1600 Washington Ave \\ Conway, Arkansas, 72032 \\ United
  States of America}

\maketitle

\begin{abstract}
  This paper presents a combinatorial theory of formal power
  series. The combinatorial interpretation of formal power series is
  based on the concept of species of structures. A categorical
  approach is used to formulate it. A new proof of Cayleyâ€™s formula
  for the number of labelled trees is given as well as a new
  combinatorial proof (due to G. Labelle) of Lagrange's inversion
  formula. Polya's enumeration theory of isomorphism classes of
  structures is entirely renewed.  Recursive methods for computing
  cycle index polynomials are described. A combinatorial version of
  the implicit function theorem is stated and proved. The paper ends
  with general considerations on the use of coalgebras in
  combinatorics.
\end{abstract}

\section{Introduction}
\label{sec:introduction}

The aim of this work is simultaneously to explain, clarify, and unify
the subject.  The usefulness of formal series in combinatorial
calculations is well established.  The combinatorial interpretation of
the substitution operation has been the subject of relatively recent
work (\citet{bender1971enumerative, doubilet1975generating,
  foata1970theorie, garsia1976lecture, gessel1977generating}). The
first interpretation (probabilistic) of the substitution of power
series dates back to Watson \citep{kendall1966branching} (in the
theory of branching processes).

The main feature of the theory presented here is its degree of
generality and simplicity. In this theory, the combinatorial objects
corresponding to formal series are the species of structures. The
emphasis is placed on the transport of structures rather than on their
properties. This point of view is reminiscent of that of
\citet{ehresmann1965categories} and contrasts with that of
\citet{bourbaki1968elements}. The combinatorial operations on formal
series correspond to operations on species of structures. Algebraic
identities between formal expressions often correspond to
combinatorial identities.  Intuition and calculation can then play on
two fronts in a dialogue that resembles that between algebra and
geometry. The result is a kind of combinatorial algebra analogous to
the geometric algebra of Grassman (and Leibniz). The simplicity of the
theory is largely due to the use it makes of the concepts of category
theory \citep{mac1971categories} (previous theories mainly use the
theory of ordered sets and partitions). Furthermore, it highlights the
fundamental fact that a very large number of constructed bijections
are \emph{natural}, that is to say, they do not depend on a system of
coordinates introduced by means of an arbitrary enumeration.

The work contains a few combinatorial innovations, like the concept of
the \term{vertebrate} and a new proof of Cayley's result on the number
of trees. There is also a new combinatorial proof of Lagrange's
inversion theorem. Polya theory is entirely redone and results in a
method for calculating by \emph{recurrence} the coefficients of cycle
index polynomials.

The theory presented here is partial. Several fundamental aspects have
not been addressed. For example, there is a very general categorical
theory of the substitution operation \citep{kelly1974clubs}. Further
developments probably require such a level of generality. We limit
ourselves to those aspects most suitable (in the opinion of the
author) for capturing the attention of a reader unfamiliar with the
concepts of category theory.

I am especially grateful to G. Labelle for expressing interest in the
author's questions, and to whom I owe the proof of Lagrange's
inversion theorem presented here. I am also indebted to J. Beck, F. W.
Lawvere, P. Leroux, J. Labelle and S. Schanuel for stimulating
conversations on the possible relationship between combinatorics and
category theory. I thank G. C. Rota for encouraging me to write this
work. I also thank Cathy Kicinski for her work of typing.  Finally,
this work, written in the sunny Australian spring, would never have
been possible without the hospitality of Max Kelly of the University
of Sydney.

\section{Species of Structures}
\label{sec:species-of-structures}

There already exists a precise concept of species of structures
\citep[Chap.\ 4]{bourbaki1968elements}. Describing a particular species
is often done by specifying the conditions which a structure must
satisfy to belong to the species.  This description may take the form
of an axiomatic theory of the species being considered. A key part of
the concept is the transport of structures.

We will abstract the concept of species so that the transport of
structures is the main aspect. Moreover, as we only deal
with the problems of counting and finite enumeration, we will confine ourselves
to finitary species, unless otherwise noted.

\begin{commentary}
  See \citet[pp. 6--7]{BLL} for some examples of ``axiomatic theories
  of species''. The main point here is about \emph{transport} of
  species, that is, the ability to ``swap out'' the labels in a
  structure for some other labels.  Apparently, in (most?) previous
  treatments this was taken as something secondary, a desideratum to
  be verified after each definition; Joyal's insight is to make
  transport itself the central defining feature of species.
\end{commentary}

\subsection{Species and cardinality}
\label{sec:species-and-cardinality}

\begin{defn}
  A (finitary) species is an endofunctor $M: \B \to \B$
  on the groupoid $\B$ of finite sets and bijections.
\end{defn}

If $E$ is a finite set, $M [E]$ is the set of all \term{structures} of
the species $M$ on $E$. We say that $E$ is the \term{underlying} set
of $s \in M[E]$, or also that it is \term{supported} by $E$. We say
also, in an abuse of language, that $s$ is an \term{element} of $M$
($s \in M$) and that it is an \term{$M$-structure}.

\begin{commentary}
  Commentary explaining $\B$.  Remind what a groupoid is.  Show what
  $\B$ looks like.  Note that any groupoid in fact looks like a disjoint
  union of cliques. (Can probably steal a bunch of the above from my
  dissertation.)

  The fact that a species is a \emph{functor} corresponds to the idea
  of ``baking in'' the notion of \emph{transport}: functors send not
  only objects to objects (in this case, sets of labels to sets of
  structures) but also morphisms to morphisms (in this case,
  bijections between label sets to bijections between labelled
  structures).

  \todo{Give some simple examples.}

  Many modern treatments define species as functors $\B \to \E$, where
  $\E$ is the category of (finite) sets and total functions (not
  bijections) \todo{cite some thing(s)}.  Note, however, that functors
  necessarily preserve isomorphisms, so every bijection in $\B$ must
  actually map to a bijection in $\E$.  Thus, for most purposes the
  distinction is not an important one.  In fact, functors $\B \to \E$
  are introduced later, in \pref{sec:category-of-species}.
\end{commentary}

If $u: E \to F$ is a bijection, the element $t = M [u] (s)$ is the
structure on $F$ obtained by \term{transport along $u$}. The bijection
$u$ is an \term{isomorphism} between $s$ and $t$:
\[ u : s \to t. \]
\begin{commentary}
  Note that $u : s \to t$ is a mild abuse of notation; $u$ is, of
  course, a bijection between label sets $E$ and $F$.  The point is
  that, via transport, $u$ induces a bijection between the sets of
  structures $M[E]$ and $M[F]$.  If $s \in M[E]$ and $t \in M[F]$ are
  related by this bijection then we say that $s$ and $t$ are
  isomorphic.

  A concrete example should help to make the idea clear.  \todo{example
  here of isomorphic trees, as well as non-isomorphic trees.}
\end{commentary}
We denote by $\el (M)$ the category whose objects are the $M$-structures and
whose morphisms are isomorphisms of $M$-structures; it is the
groupoid of \term{elements} of $M$.

There is a \term{forgetful}
functor $U: \el (M) \to \B$ whose
value on $s \in M$ is the \term{underlying} set of the structure $s$. The concept
of isomorphism of structures defines an equivalence relation whose
classes are the \term{types} of structures of the species M; these classes are
the \term{connected components} of the groupoid $\el (M)$. We use the notation
$\pi_0 (M)$ to denote the set of types (of structures) of the species $M$. If
$s \in M$, we denote the \term{type} of $s$ by the notation $|s| \in \pi_0 (M)$.

\newcommand{\Simp}{\mathcal{S}}

\begin{ex}
  Recall that a \emph{simplicial scheme} structure on $E$ is a set
  $\Simp$ of non-empty subsets of $E$ such that (i) every non-empty
  subset contained in an element of $\Simp$ belongs to $\Simp$, (ii)
  the singletons $\{x\}$ for $x \in E$ belong to $\Simp$. The elements
  of $\Simp$ are \emph{simplices}. The dimension of a simplex is one
  less than its cardinality. A \emph{graph} is a simplicial scheme
  whose simplices have dimension $\leq 1$. If $u : E \to F$ is a
  bijection, it is clear that $u (\Simp) = \{u(S) \mid S \in \Simp\}$
  is also a simplicial scheme structure on $F$. We can therefore
  consider the \emph{species} of simplicial schemes. It is also clear
  that if $\Simp$ is a graph then $u(\Simp)$ is one too; we obtain the
  species of graphs, which is a \emph{subspecies} of the species of
  simplicial schemes. More generally, any property $P$ which applies
  to simplicial schemes, and which is invariant under isomorphism,
  determines a subspecies of the species of simplicial schemes. For
  example, connectedness is such an invariant property. The species of
  \emph{forests} is that of graphs \emph{without cycles}, the species
  of \emph{trees} is that of connected forests, etc.
\end{ex}

\begin{ex} \label{ex:endofunctions}
  The transport of an endofunction $a : E \to E$ along a bijection $u
  : E \bij F$ is by \emph{conjugation}: $\phi \mapsto u \phi
  u^{-1}$. The species of \emph{permutations} is a subspecies of the
  species of endofunctions. If we require that the graph of an
  endofunction is connected, we obtain the subspecies of
  \emph{connected endofunctions} and, likewise, that of \emph{circular
    permutations}. An important concept is that of \emph{contraction}:
  an endofunction $\phi : E \to E$ is a contraction if there exists
  $x_0 \in E$ such that for every $x \in E$ we have $\phi^n(x) = x_0$
  when $n$ is large enough. That is, a contraction is an endofunction
  which is ultimately constant.
\end{ex}

\begin{ex}
  Let $S$ be the species of permutations. Consider the groupoid $\el
  (S)$ of elements of $S$. The objects of $\el (S)$ are the sets $E
  \in \B$ equipped with a permutation $\sigma_E \in S [E]$. The
  morphisms $(E, \sigma_E) \to (F, \sigma_F)$ are the bijections $u: E
  \to F$ such that $u\sigma_E = \sigma_F u$. Let $x_1, x_2, x_3,
  \dots$ be an infinite sequence of variables.  Let $I (\sigma_E) =
  x_1^{d_1} \dots x_n^{d_n}$, where $n = \Card E$ and where $d_i$ is
  the number of cycles of length $i$ in $\sigma_E$. Two objects $(E,
  \sigma_E)$ and $(F, \sigma_E)$ in $\el (S)$ are isomorphic if and
  only if $I (\sigma_E) = I (\sigma_F)$. The set $\pi_0(S)$ of
  connected components of the groupoid $\el (S)$ is therefore
  naturally identified with the set $\Mon(x)$ of all monomials in the
  variables $x_1, x_2, x_3, \dots$
\end{ex}

\subsubsection{}
The group $E!$ of permutations of $E$ acts on $M [E]$ by transport
of structures. The set $\pi_0 (M [E])$ of \emph{orbits} is identified
with the set of types of $M$-structures supported by sets equipotent
with $E$. We identify the orbit of $s \in M[E]$ with its type
$|s|$. The \emph{stabilizer} subgroup of an element $s \in M [E]$ is
the group $\Aut (s)$ of \emph{automorphisms} of $s$. We have the
well-known formula \[ \Card |s| = \frac{n!}{\Card \Aut(s)}. \]

One of the fundamental problems of enumerative combinatorics is to
evaluate the two infinite sequences of numbers
\begin{gather}
  \Card M[n], \quad \text{$n \geq 0$ ($[n] = \{1, 2, \dots, n\}$)}, \\
  \Card \pi_0(M[n]), \quad n \geq 0.
\end{gather}

We define two generating functions. The first is a series of Hurwitz
\citep{comtet1974combinatorics}:

\begin{equation}
  M(x) = \sum_{n \geq 0} \Card M[n] \frac{x^n}{n!}.
\end{equation}

The second is a power series with integer coefficients (without
factorial):

\begin{equation}
  \unl M(x) = \sum_{n \geq 0} \Card \pi_0(M[n]) x^n.
\end{equation}

We say that $M (x)$ is the \emph{cardinality} of $M$. Let us see
immediately that the calculation of $\unl M (x)$ boils down to
computing the cardinality of the \emph{associated} species $\unl M$.

\begin{defn} \label{defn:unl}
  A structure of the species $\unl M$ is a pair $(\sigma, s)$ where
  $\sigma$ is an automorphism of $s \in M$.
\end{defn}

\begin{prop}
  We have
  \[ \unl M (x) = \Card {\unl M}. \]
\end{prop}

\begin{proof}
  We use Burnside's lemma: if a finite group $G$ acts on a finite set
  $X$, then the cardinality of the set $\pi_0(X)$ of orbits of $X$ is
  equal to that of the set $\{(\sigma, x) \mid \sigma \in G, x \in X,
  \sigma \cdot x = x\}$ \emph{divided by} $\Card G$. (See
  \citet[p. 191, Theorem VII]{burnside1955groups}.)
\end{proof}

\subsection{The category of species}
\label{sec:category-of-species}

Species form a category: they are functors, and one can take natural
transformations as morphisms. As it is desirable to have a larger
class of morphisms than that of isomorphisms, it is best to consider a
species as a functor $M: \B \to \E$ to the category $\E$ of finite
sets and \emph{functions} (by composing with the inclusion $\B \inj
\E$).

\begin{defn}
  A \emph{morphism} $\alpha : M \to N$ is a natural transformation
  from $M$ to $N$, considered as functors from $\B$ to $\E$.
\end{defn}

One can interpret $\alpha$ as follows: one has a \emph{construction}
$\alpha$ allowing one to produce a structure of the species $N$
(output) from a structure of the species $M$ (input), and for every
bijection $u : E \to F$ the rectangle \[ \xymatrix{M[E]
  \ar[r]^{\alpha_E} \ar[d]_{M[u]} & N[E] \ar[d]^{N[u]} \\ M[F]
  \ar[r]^{\alpha_F} & N[F] } \] commutes; this means that the
construction is \emph{equivariant} (or invariant): it does not change
if one \emph{simultaneously} transports the input and the output along
the same bijection; the vast majority of mathematical constructions
have this property.

If $\sigma_E$ is invertible regardless of $E$, the morphism $\alpha$
is an \emph{isomorphism} between $M$ and $N$. In this case, we write
$M \stackrel{\alpha}{=} N$, or more simply (in an abuse of notation) $M
= N$. If $M$ and $N$ satisfy the weaker condition $\Card M = \Card N$,
we say that $M$ and $N$ are \emph{equipotent} species, and we write $M
\equiv N$.

\begin{ex}
  The construction of the transitive closure of a graph determines a
  morphism from the species of graphs to the species of partitions.
\end{ex}

\begin{ex} \label{ex:rooted-tree}
  A \emph{rooted tree} is a tree equipped with a \emph{root} (which is
  an arbitrary vertex of the underlying set). We usually orient the
  edges of a rooted tree in the direction of the root. If we adjoin a
  loop to the root, we obtain the graph of a \emph{contraction}
  (\pref{ex:endofunctions}). There is an \emph{isomorphism} between
  the species of rooted trees and the species of contractions.
\end{ex}

\begin{ex}
  The species of linear orders, of permutations, of permutations
  equipped with a fixed point, and of circular permutations equipped
  with an automorphism are all \emph{equipotent}, without being
  isomorphic.
\end{ex}

\subsubsection{} A morphism of species $M \to N$ determines a functor
$\el (M) \to \el (N)$ between the corresponding groupoids. Note that
this functor commutes with the forgetful functors \[ \xymatrix@C=0.7em{\el(M)
  \ar[rr] \ar[dr]_U & & \el(N) \ar[dl]^U \\ & B.} \]
It is not true that a functor $\el (M) \to \el (N)$ is always induced
by a morphism of species $M \to N$. For example, if $M$ is the species
of preorders and $N$ the species of the orders, the usual construction
of an order relation to from a pre-order (on a quotient of the
pre-order's underlying set) determines a functor $\el (M) \to \el (N)$
that \emph{does not come} from a morphism of species $M \to
N$. However, it is easily checked that every functor $\el (M) \to \el
(N)$ which commutes with the forgetful functors $U$ is induced by one
and only one species morphism $M \to N$.

\subsection{Relative species}
\label{sec:relative-species}

We want to examine the concept of a \emph{relative} species. We begin
with an example. Let $G$ be the species of \emph{graphs}. The concept
of \emph{orientation} gives us a functor $O : \el (G) \to \E$, because
one can transport a graph orientation along a graph isomorphism. The
species of \emph{orientations} (of a graph) is \emph{relative} to that
of graphs. On the other hand, the species $GO$ of \emph{oriented
  graphs} is equipped with a projection $GO \to G$.

\begin{defn}
  Let $M$ be a species. A species \emph{relative} to $M$ is a functor
  $T_M : \el (M) \to \E$.
\end{defn}

\todo{Ugh, this paragraph will need a lot of commentary and/or some
  nice pictures.}
Given $T_M$, one can construct a species $T$
equipped with a morphism $T \to^p M$: set $T [E] = \{(s, \alpha) \mid
s \in M [E], \alpha \in T_M[s]\}$. To transport $(s, \alpha) \in T[E]$
along a bijection $u : E \to F$ we begin by transporting $s$ to obtain
$t = M [u] (s)$, which gives first an isomorphism $s \to^u t \in
\el(M)$ and then $\beta = T_M [u] (\alpha)$; we set $T [u] (s, \alpha)
= (t, \beta)$. The morphism $p : T \to M$ is the projection $p (s,
\alpha) = s$. Conversely, given a morphism $T \to^p M$, we can
construct $T_M$: if $s \in M [E]$, we have $p_E: T [E] \to M [E]$ and
set $T_M [s] = p_E^{-1}\{s\} \subseteq T [E]$. Naturality of $p$
allows us to verify that if $u : E \to F$ is an isomorphism between $s
\in M [E]$ and $T \in M [F]$ then $T [u]$ turns $p_E^{-1} \{s\}$ into
$p_E^{-1} \{t\}$, which gives $T_M [u] : T_M [s] \to T_M [t]$. We
have, in fact, a precise proposition: a \term{species over $M$} is a
species $T$ equipped with a morphism $T \to^p M$. A morphism $(T, p)
\to (T', p')$ between species above $M$ is an arrow $T \to^u T'$ such
that $p'\ u = p$.

\begin{prop}
  The constructions described above define a equivalence between the
  category of species relative to $M$ and the category $E \|X\|/_M$ of
  species over $M$. \emph{(See \pref{sec:combinatorial-operations} for the
  notation $E\|X\|$.)}
\end{prop}

Suppose $T_M: \el (M) \to E$ is given. We often say that $(s, \alpha)
\in T [E]$ is an $M$-structure $s$ \term{equipped} with an element
$\alpha \in T_M[s]$. For example, a directed graph is a graph
\term{equipped} with an orientation. A structure of the species
$\tilde M$ (\pref{defn:unl}) is an $M$-structure \term{equipped} with an
automorphism.  \emph{etc.}

We sometimes use the term ``enriched'' rather than ``equipped''. Thus,
if $R$ is any species, we will say that endofunction $\phi : E \to E$
is \term{$R$-enriched} if each of its \term{fibers} $\phi^{-1}\{x\}$,
$x \in E$ is equipped with an $R$-structure.  Similarly, let $a$ be an
rooted tree on $E$. The \term{fiber} $a^{-1}\{x\}$ of a vertex $x \in
E$ is the set of vertices of $a$ connected to $x$ by an edge adjacent
to $x$ (for the orientation of a tree as described in
\pref{ex:rooted-tree}). We say that $a$ is \term{$R$-enriched} if each
of its fibers is equipped with an $R$-structure. (Keeping in mind the
empty fibers.)

In graphical representations of endofunctions or $R$-enriched trees it
is often convenient to assume that $R$-structures on the fibers are
placed on the set of \emph{edges} of the fibers.  For example, an
$R$-enriched tree can be represented as in \pref{fig:enriched-tree}
where an arc cutting through the edges of a fiber denotes an
$R$-structure. Don't forget the leaves.
\begin{figure}
  \centering
  \begin{diagram}[width=300]
import Diagrams
dia = drawEnrichedTree (layoutEnrichedTree figure0) # frame 0.5
  \end{diagram}
  \caption{An $R$-enriched tree} \label{fig:enriched-tree}
\end{figure}

\section{The Combinational Operations}
\label{sec:combinatorial-operations}

\newcommand{\Poly}[2]{#1 \llbracket #2 \rrbracket}

The category of species is rich in various operations. In this
section, we describe several operations of which three are binary.
The first two are the sum (disjoint) and the product. With these two
operations, the category of species becomes a kind of semi-ring.  More
precisely, let $R$ be a commutative ring, and denote by $\Poly R x$
the ring of Hurwitz series with coefficients in $R$: these are the
formal series
\[ \sum_{n \geq 0} a_n \frac{x^n}{n!}, \quad \text{where $n \geq 0,
  a_n \in R$.} \] The continued analogy here is that the category of
species would be the semiring $\Poly{\E}{X}$ of Hurwitz series, but
\emph{with coefficients from the category $\E$ of finite sets}. The
concept of cardinality induces a \emph{homomorphism}
\[ \Card : \Poly{\E}{X} \to \Poly{\Z}{x}. \]

In addition, the evaluation $M \mapsto M [0]$ is a functor preserving sum and
product
\[ \Poly \E X \to \E \]
whose kernel $J$ is an ideal on which we will describe the operations
of \term{divided powers} \citep{cartan1954seminaire}
\[ \gamma_n : J \to \Poly \E X \quad \text{($n \geq 0$)} \]
so that we have
\[ \Card \gamma_n(M) = \frac{M(x)^n}{n!} \quad \text{($n \geq 0$)}. \]

Using these operations of divided powers we then describe
the operation of \term{substitution} of one species into another. We end this
chapter with an introduction to the \term{differential calculus} of species
and a \emph{combinatorial} proof of the Lagrange inversion formula.

\subsection{Sum and product}

The disjoint sum of two species $M$ and $N$ is the \emph{coproduct}
in the category of species:
\[ (M + N) [E] = M [E] + N [E]. \]

More generally, an arbitrary family of species $(M_i)_{i \in I}$ is
summable if for any finite set $E$, the set of indices $i \in I$ for
which $M_i[E] \neq \varnothing$ is finite.  We set
\[ \left( \sum_{i \in I} M_i \right) [ E ] = \sum_{i \in I} M_i[E]. \]
It is clear that $\Card$ preserves sum. We now turn to the definition
of the \term{product} $M \cdot N$ of two species $M$ and $N$. Define
first a \term{partition} of a set $E$ into two \term{parts} is a pair
$(E_1, E_2)$ such that $E_1 \union E_2 = E$ and $E_1 \intersect E_2 =
\varnothing$. One defines in the same way the concept of a partition
of $E$ into $n$ pieces ($n \in \N$): we write $E = E_ + \dots + E_n$
to indicate that $(E_1, \dots, E_n)$ is a partition of $D$ into $n$
pieces.

\begin{defn}
  A structure of the species $M \cdot N$ on $E \in \B$ is a quadruplet
  $(E_1, E_2, s, t)$, where $E = E_1 + E_2$ and $(s, t) \in M[E_1]
  \times N [E_2]$.
\end{defn}

\begin{prop}
We have
\[ \Card (M \cdot N) = \Card (M) \cdot \Card (N). \]
\end{prop}
\begin{proof}
By definition,
\[ (M \cdot N)[E] = \sum_{E_1 + E_2 = E} M[E_1] \times N[E_2]. \]
If $\Card E = n$ and $0 \leq k \leq n$ there are $\binom n k$
partitions $E = E_1 + E_2$ with $\Card E_1 = k$.  As a result,
\[ \Card(M \cdot N) [n] = \sum_{k=0}^n \binom n k \Card M [k] \Card N
[n - k]. \]
\end{proof}

The \term{uniform} species is a species with only one structure on
each set; one can give it various representations: the structures of
complete graphs, chaotic topologies, and \trans{identity
  functions}{applications identiques}
determine the uniform species.

\begin{ex}
  Let $S$ be the species of \term{permutations}, and $S_0$ that of
  permutations without \emph{fixed points}, and $U$ the uniform
  species. We have $S = S_0 \cdot U$ (\pref{fig:permutation}); taking
  cardinalities, we get:
\[ \frac{1}{1-x} = S_0 (x) e^x \]
and therefore
\[ S_0 (x) = \frac{e^{-x}}{1 - x}. \]
\end{ex}

\begin{figure}
  \centering
  \missingfigure{Permutation partitioned into fixed points and no
    fixed points.}
  \caption{XXX}
  \label{fig:permutation}
\end{figure}

\begin{ex}
  Let $D$ be the species of endofunctions, $D_0$ the species of
  endofunctions equipped with a fixed point, and $A$ and the species
  of rooted trees. Then
  \[ D_0 = A \cdot D. \] Indeed, one can partition the domain $E$ of
  an endofunction $\phi$ equipped with a fixed point $x_0$ into two
  parts $E = E_1 + E_2$. The first, $E_1$, consists of all the points
  ultimately transformed into $x_0$ by $\phi$. On $E_1$, $\phi$
  induces a contraction (\pref{ex:endofunctions}), which is equivalent
  to a rooted tree. On the second part $E_2$, $\phi$ induces an
  arbitrary endofunction (\pref{fig:endofunction}).
\end{ex}

\begin{figure}
  \centering
  \missingfigure{Endofunction}
  \caption{XXX}
  \label{fig:endofunction}
\end{figure}

The \emph{product} $M = \prod_{i=1}^n M_i$ of a finite sequence of
species can be explicitly defined as follows: a structure of the
species $M$ on $E$ is a \emph{partition} $E = E_1 + \dots + E_n$ where
each part $E_i$ (possibly empty) is \emph{equipped} with a structure
of the species $M_i$.

One can also describe the \term{power} $N^S$ of a species $N$ by a
finite set $S$: a structure of the species $N^S$ on $E$ is a function
$\chi : E \to S$ where each fiber is \emph{equipped} with a structure
of the species $N$; in other words, it is an \emph{$N$-enriched}
function.

\begin{ex}[Joyal] \label{ex:vertebrate}
  A \emph{vertebrate} is a tree \term{bipointed} by a pair $(p_0,
  p_1)$ of vertices. We say that $p_0$ is the \term{tail vertex} and
  $p_1$ the \term{head vertex}. The shortest path from the tail vertex
  to the head vertex is the \term{spine}. The vertices along the spine
  are \term{vertebrae}. For each vertex $p$, let $v(p)$ be the
  vertebra closest to $p$. The function $v$ is idempotent, and there
  is a rooted tree structure on each fiber of $v$.  The roots of these
  trees are the vertebrae. Thus, a vertebrate on $E$ determines a
  variable length partition $E = E_1 + \dots + E_n$, in which each
  part $E_i$ is equipped with a rooted tree structure, and vice
  versa. So we have the identity:
  \[ V = A + A^2 + A^3 + \dots, \] where $V$ is the species of
  vertebrates and $A$ that of rooted trees (\pref{fig:vertebrate}).
\end{ex}

\begin{figure}
  \centering
  \missingfigure{vertebrate}
  \caption{XXX}
  \label{fig:vertebrate}
\end{figure}

\begin{ex}
  Let $L$ be the species of linear orders and $S$ a finite set.  A
  structure of the species $L^S$ on $E$ is a function $E \to S$ where
  each fiber is equipped with a linear order. The number $l(n, s)$ of
  such objects (if $n = \Card E$ and $s = \Card S$) is the coefficient
  of $x^n/n!$ in the series $(1-x)^{-s}$. This shows that
  \[ l(n, s) = s (s + 1) \dots (s + n-1). \]
\end{ex}

Hereafter, we will often consider that a finite set $A$
determines a species by setting
\[ A [E] = \begin{cases} A \quad \text{if $E = \varnothing$} \\ \varnothing \quad \text{otherwise}. \end{cases} \]
With this convention, the category $\E$ acts as a ring of coefficients
for $\Poly \E X$, because the disjoint sum and Cartesian product of sets
can be conflated with the sum and product of species as described
earlier.

\subsection{Divided powers and substitution}

\begin{defn}
  Let $N$ be a species such that $N [0] = \varnothing$ and let $E$ be
  a finite set. An \term{assembly} of structures of the species $N$ on
  $E$ is a partition of $E$ where each class is equipped with a
  structure of the species $N$.  A \term{member} of the assembly is a
  class equipped with the corresponding $N$-structure. The
  \term{divided power} $\gamma_n(N)$ is the species of assemblies of
  $N$-structures with exactly $n$ members. The \term{exponential}
  $\exp (N)$ is the species of all assemblies of $N$-structures.
\end{defn}

\begin{prop}
We have
\begin{align*}
\Card \gamma_n(N) &= \frac{N(x)^n}{n!}, \\
\Card \exp (N) &= \exp (N (x)).
\end{align*}
\end{prop}

\begin{proof}
It obviously suffices to prove the first identity.  Note first
that a structure of the species $N^n$ on $E$ determines a partition $E
= E_1 + \dots + E_n$ into \emph{non-empty} (and disjoint) parts:
indeed, $E_i$ is equipped with an $N$-structure and by hypothesis $N
[0] = \varnothing$. If we forget about the linear order on the parts,
we have a partition $\{E_1, \dots, E_n\}$ where each class is equipped
with an $N$-structure. We have shown that an $N^n$-structure is none
other than an $N$-assembly whose members have been placed in a
\emph{linear order}:
\[ \Card N^n = n! \Card \gamma_n(N). \]
\end{proof}

For many species, one may indicate a concept of \term{connectedness}
and demonstrate that any structure consists of a partition
where each class is equipped with a connected structure. Under these conditions, a
species $M$ is isomorphic to the species of assemblies of connected structures:
$M = \exp (M_C)$.

\begin{ex}
  \term{Forests} are assemblies of trees. Forests of rooted trees are
  assemblies of rooted trees. Permutations are assemblies of circular
  permutations. Partitions are assemblies of partitions with a single
  class, \etc
\end{ex}

The operation of \term{substitution} of one species into another is
the richest in possibilities.

\begin{defn}
Let $R$ and $N$ be species and assume that $N [0] = \varnothing$.
The species $R (N)$ is that of pairs $(a, \rho)$, where $a$ is an assembly of $N$-
structures and $\rho$ is an $R$-structure on the set of members of $a$.

We say that $R (N)$ is the result of \term{substituting} $N$ into $R$. We
say that an element of $R (N)$ is an $R$-assembly (of $N$-structures). Note
immediately that $\exp (N)$ is the result of substituting $N$ in
the \emph{uniform} species (Ex. 7).
\end{defn}

\begin{thm} \label{thm:card-subst}
  Assuming $N [0] = \varnothing$, we have
  \[ \Card R (N) = R (N (x)). \]
\end{thm}

\begin{proof}
For each integer $n \geq 0$, let $R_n$ be the species of $R$-structures
where the underlying set has cardinality $n$. It has a decomposition
as a disjoint sum
\[ R = \sum_{n \geq 0} R_n, \]
inducing a decomposition of $R$-assemblies according to the number of
members:
\[ R (N) = \sum_{n \geq 0} R_n(N). \]
An element of $R_n(N)$ is an assembly of $n$ members \emph{equipped} with an $R$-structure.
We have therefore
\[ \Card R_n(N) = \Card \gamma_n(N) \times \Card R [n], \]
resulting in
\begin{align*} \Card R(N) &= \sum_n \geq 0 \Card R[n]
  \frac{N(x)^n}{n!} \\
  &= R(N(x)).
\end{align*}
\end{proof}

\begin{rem}
  To think combinatorially it is necessary to give visual
  representations. To grasp the nature of a species is to be capable
  of representing the general shape of its structures. The
  \emph{shape} of a structure is invariant under
  isomorphism. \trans{What is needed to represent first is the general
    type of structures of a given species}{Ce qu'il faut arriver \`a
    se repr\'esenter d'abord c'est le type g\'en\'eral des structures
    d'une esp\`ece donn\`ee}.  This type is independent of a labelling
  or an enumeration of the vertices of the underlying set. For
  example, suppose that we want to represent the general type of
  structures of the species $R(N)$ knowing that we already have a
  representation for $R$ and $N$. What we can do is to literally
  substitute arbitrarily selected $N$-structures in place of each
  vertex of an $R$-structure, For this, one can imagine that the
  vertices of the $R$-structure blow up into cells containing the
  $N$-structures.  The underlying set of a cellular configuration is
  the sum of the underlying sets of the structures contained in the
  cells. Thus, if we substitute the species of circular permutations
  into the species of trees, we obtain a species whose general type
  can be represented as in \pref{fig:tree-of-cycles}.

  \begin{figure}
    \centering
    \missingfigure{tree of cycles}
    \caption{XXX}
    \label{fig:tree-of-cycles}
  \end{figure}

This representation is not the only one, and it is convenient to adapt to
the particularities of a species. For example, suppose that the species $N$
is \emph{pointed}, that is, equipped with a morphism $N \to^p B$ where $B$ is the species
of ``vertices'' ($B [E] = E$ for $E \in B$). Each structure $s \in N[E]$ then has
a \emph{base point} $p (s) \in E$. One can used the base points to
give another representation of $R (N)$-structures: for each vertex
of an $R$-structure one chooses an $N$-structure and makes the vertex \emph{coincide}
with the base point of the selected $N$-structure. For example, the base point
a rooted tree is the root; if we substitute the species $A$ of rooted trees
into that of (nonempty) linear orders, we obtain the species of vertebrates
(Ex. 9). When $N$ is pointed we can define substitution as follows: an
$R (N)$-structure on $E$ is a triplet $(v, \alpha, \beta)$, where
\begin{enumerate}
\item $v$ is an idempotent function $E \to E$,
\item $\alpha$ is a function that selects for each $x \in \Im (v)$ a
  structure $\alpha (x) \in N [v^{-1}\{x\}]$ such that the base point
  of $\alpha (x)$ \emph{coincides} with $x \in v^{-1}\{x\}$,
\item $\beta$ is an $R$-structure on $\Im (v)$.
\end{enumerate}
\end{rem}

\begin{ex} \label{ex:endo-perm-of-rooted}
Let $D$ be the species of endofunctions, $S$ that of
permutations, and $A$ that of rooted trees. We have the decomposition
\[ D = S(A). \] Indeed, let $\phi \in D [E]$. A point $x \in E$ is
\term{periodic} if there exists an integer $n \geq 1$ such that
$\phi^n(x) = x$. The function $\phi$ \term{permutes} the periodic
points.  For each $x \in E$ let $v (x)$ be the first periodic point in
the sequence $x, \phi(x), \phi^2(x) \dots$. The function $v$ is
idempotent and its image is the set of periodic points. For each $x
\in \Im (v)$ the fiber $v^{-1}\{x\}$ is equipped with a rooted tree
structure whose root is $x$. \emph{Conversely}, if one has an assembly
of rooted trees and a permutation of the set of roots, it is clear
that one can construct a corresponding endofunction $\phi$
(\pref{fig:perm-of-rooted-trees}).
\end{ex}

\begin{figure}
  \centering
  \missingfigure{Permutation of rooted trees}
  \caption{XXX}
  \label{fig:perm-of-rooted-trees}
\end{figure}

Examples 9 and 12 give a simple proof of Cayley's theorem: the number
$a_n$ of trees on a set of cardinality $n \geq 1$ is
$n^{n-2}$. Indeed, the number of vertebrates (bipointed trees) is
equal to $n^2a_n$.  Example 9 shows that the vertebrates are
\emph{linear} assembies of rooted trees.  Example 10 shows that
endofunctions are \emph{permuted} assemblies of rooted trees.  As the
number of linear orders coincides with the number of permutations, one
obtains $n^2 a_n = n^n$ $(n \geq 1)$.

\pref{thm:card-subst} suggests adopting the notation $M (X)$ to
designate a species $M$. The variable $X$ is interpreted as the
\emph{singleton} species: there is only a single structure of the
species $X$ (up to isomorphism) and it is \trans{supported by the
  singletons}{port\'ee par les singletons}.  The result $M (X)$ of the
substitution of $X$ in $M$ is isomorphic to $M$. For some species we
adopt a \trans{frankly}{franchement} algebraic notation if it does not
create ambiguity. Thus, $\exp (X)$ or $e^X$ designate the uniform
species, $X e^X$ the species of pointed sets, $e^X - 1$ the uniform
nonempty species, $\cosh (X)$ and $\sinh (X)$ the uniform even and odd
species, $1/(1 - X)$ the species of linear orders, \etc However, we
retain the notation $S (X)$ to designate the species of permutations
in order to avoid confusion with $1/(1-X)$. Similarly, we will use the
notation $C (X)$ rather than $\log 1/(1-X)$ to designate the species
of circular permutations, \etc

\begin{ex}
  A preorder relation $\leq$ on $E$ determines an equivalence
  relation: $x \equiv y$ if and only if one has $x \leq y$ and $y \leq
  x$.  The preorder relation induced on the quotient $E / \equiv$ is
  an \trans{order relation}{relation d'ordre}, and conversely.  This
  shows that the species of preorders is obtained by substituting the
  species $e^X - 1$ in the species of order relations. In particular,
  the species of total preorders is
  \[ \frac{1}{1 - (e^X - 1)} = \frac{1}{2 - e^X}. \]
\end{ex}

\begin{ex}
  In a graph, two vertices are \term{doubly connected} if we can
  connect them with a path avoiding any edge selected beforehand. The
  vertices of a graph can be partitioned into doubly connected
  components.  Let $\Gc$ be the species of connected pointed graphs
  and $\Gcc$ that of doubly connected pointed graphs. We have the
  relation
  \[ \Gc = \Gcc(Xe^{\Gc(X)}). \] Indeed, in a connected pointed graph,
  consider the doubly connected component $H$ of the base point; for
  each vertex $x$ let $v(x)$ be the closest vertex located in the
  component $H$. We can easily verify that $v$ is well defined. It is
  an idempotent function whose fibers are equipped with a structure of
  the species $X \cdot e^{\Gc(X)}$; the image of $v$ coincides with
  the doubly connected pointed graph $H$ (\pref{fig:doubly-connected}).
\end{ex}

\begin{figure}
  \centering
  \missingfigure{doubly connected}
  \caption{XXX}
  \label{fig:doubly-connected}
\end{figure}

\begin{ex}[\citet{polya1937kombinatorische}] \label{ex:rooted-trees-eqn}
  Consider the species $A$ of rooted trees.  We have the identity
  (\pref{fig:root-plus-forest})
\[ A = X \cdot \exp (A). \]
More generally, the species $A_R$ of $R$-enriched trees satisfies
the equation (see \pref{fig:enriched-tree})
\[ A_R = X \cdot R(A_R). \]
\end{ex}

\begin{figure}
  \centering
  \missingfigure{root plus forest of rooted trees}
  \caption{XXX}
  \label{fig:root-plus-forest}
\end{figure}

\subsection{Differential calculus}

For any finite set $E$, let $E^+$ be the set obtained by adjoining to $E$
an additional item $*$:
\[ E^+ = E + \{ * \}. \]

\begin{defn}
The \term{derivative} species $M'$ of a species $M$ is defined as
follows:
\[ M' [E] = M [E^+]. \]
\end{defn}

\begin{ex}
  The derivative of the species $C (X)$ of circular permutations is
  the species of linear orders (\pref{fig:diff-cycle}):
  \[ C'(X) = \frac{1}{1 - X}. \]
\end{ex}

\begin{figure}
  \centering
  \missingfigure{derivative of a cycle}
  \caption{XXX}
  \label{fig:diff-cycle}
\end{figure}

\begin{ex}
  The derivative of the species of trees is that of forests of pointed
  trees (\pref{fig:diff-tree}).
\end{ex}

\begin{figure}
  \centering
  \missingfigure{derivative of a tree}
  \caption{XXX}
  \label{fig:diff-tree}
\end{figure}

\begin{ex}
  Recall that a graph is \term{even} if the number of edges adjacent
  to each vertex is even. The derivative of the species of even graphs
  is the species of graphs
  (\pref{fig:diff-even-graph}). \citep{harary1973graphical}.
\end{ex}

\begin{figure}
  \centering
  \missingfigure{derivative of an even graph}
  \caption{XXX}
  \label{fig:diff-even-graph}
\end{figure}

\begin{ex}
  The derivative of the species of linear orders $1 / (1-X)$ is equal
  to $(1 / (1-X)) \cdot (1 / (1-X))$.
\end{ex}

Recall that a \term{pointed} structure of the species $M$ on $E$ is an
element of $E \times M [E]$. We denote by $\pointed M$ the species of
pointed $M$-structures.

\begin{prop}
We have the relations
\begin{align*}
\pointed M &= X \cdot M', \\
(M + N)' &= M' + N', \\
(M \cdot N)' &= M' \cdot N + M \cdot N', \\
M(N)' &= M'(N) \cdot N'.
\end{align*}
\end{prop}

These identities are not only relationships between numeric quantities
but real \emph{combinatorial} identities. We leave to
the reader the pleasure of demonstrating this.

\begin{ex} \label{ex:trees-vertebrates}
To illustrate the combinatorial differential calculus,
consider the equation satisfied by the species $A$ of rooted trees:
\[ A = X \cdot e^A. \] The operation of ``pointing'' \trans{is a
  derivation}{est une d\'erivation}:
\[ \pointed A = \pointed X \cdot e^A + X \cdot e^A \pointed A. \]
Pointed, rooted trees are vertebrates:
\begin{align*}
V = \pointed A &= X \cdot e^A + X \cdot e^A V \\
&= A + A \cdot V \\
&= A + A^2 + A^3 + \dots .
\end{align*}
It has been shown that vertebrates are (non-empty) linear assemblies
of rooted trees. (See \pref{ex:vertebrate}.)
\end{ex}

\subsection{The Lagrange inversion formula}

\subsubsection{}
The methods of analysis sometimes leave traces in
the restricted world of formal series. An example is the theory of the \term{residue}
(at the point $0$) of a formal meromorphic series. The invariance property
of the residue with respect to an invertible change of parameter $x = w (t)$ is
a fundamental \emph{algebraic identity}:
\[ \Res f (x) dx = \Res f(u (t)) u' (t) dt. \]
This identity is equivalent to the \term{Lagrange inversion formula}. This
formula gives the coefficient $c_n$ of $x_n$ in the series $g (v (x))$ when $v (x)$
satisfies the equation $v (x) = xR(v (x))$:
\[ c_n = \frac{1}{n} \times \text{coefficient of $t^{n-1}$ in
  $g'(t)R(t)^n$}. \] To demonstrate this, it is sufficient to note
that this coefficient is equal to the residue at the origin of $g (v
(x))/x^{n+1}$. Note further that $u (t) = t / R (t)$ is the inverse
series of $v$. Performing the change of the parameter $x = u (t)$ and
using the invariance property yields
\begin{align*}
c_n &= \Res g(t) \frac{u'(t)}{u(t)^{n+1}} dt \\
&= \Res \left[ \frac{g'(t)}{nu(t)^n} - \left( \frac{g(t)}{nu(t)^n}\right)' \right] dt \\
&= \Res \frac{g'(t)}{nu(t)^n} dt \\
&= \frac{1}{n} \Res \frac{g'(t) R(t)^n}{t^n} dt \\
&= \frac{1}{n} \times \text{coefficient of $t^{n-1}$ in $g'(t) R(t)^n$}.
\end{align*}
Since the calculations are reversible, the equivalence between the inversion formula
and the invariance property is clear.

\subsubsection{} Since \citet{polya1937kombinatorische}, the inversion
formula is often used in combinatorics to calculate the coefficients
of certain generating series (the canonical example is the species $A$
of rooted trees that satisfy the equation $A = X \cdot \exp (A)$; see
\citet{moon1970counting}).

There is already a purely combinatorial proof of the inversion formula
\citep{raney1960functional}. That proof is based on different concepts
than those used in the following proof. In Chapter 4 XXX, we will give
another proof of the inversion formula.

\begin{thm}[Lagrange Inversion]
  Let $R$ and $F$ be species and let $A_R$ be the species of
  $R$-enriched rooted trees. For $n \geq 1$, we have:
\[ F(A_R)[n] \equiv F' R^n[n-1] \]
(the $\equiv$ denotes equipotence).
\end{thm}

\begin{proof}
  Recall (\pref{ex:rooted-trees-eqn}) that $A_R$ satisfies the
  equation
\[ A_R = X \cdot R (A_R). \]
This leads to the derivation
\begin{align*}
A_R' &= R(A_R) + X \cdot R'(A_R) A_R' \\
&= R (A_R) + C_R A_R'
\end{align*}
and by iteration ($C_R = X \cdot R'(A_R)$)
\begin{align*}
&= R (A_R) (1 + C_R + C_R^2 + \dots) \\
&= R(A_R) \frac{1}{1 - C_R}.
\end{align*}
At this point, we want to replace $1 / (1 - C_R)$ by $S(C_R)$, where
$S$ is the species of permutations. We need to interpret the result of
such replacement combinatorially.

\begin{lem}[\citet{labelle1981nouvelle}]
  The species $C_R = X \cdot R'(A_R)$ coincides with that of
  $R$-enriched contractions. (See \pref{sec:relative-species} and
  \pref{ex:rooted-tree}.)
\end{lem}

\begin{proof}
  Indeed, consider an $R$-enriched contraction $\phi : E \to E$. Let
  $x_0$ be the point of convergence of $\phi$. We can partition $E$
  into two parts: $\{x_0\} + E - \{x_0\}$. On the second part, there
  is the structure of an $R'$-assembly of $A_R$-structures as seen in
  \pref{fig:Rprime-AR} (the loop explains the presence of the
  derivative in the formula $C_R = X \cdot R'(A_R)$). \emph{And
    conversely.}
\end{proof}

\begin{figure}
  \centering
  \missingfigure{$R'$-assembly of $A_R$-structures}
  \caption{XXX}
  \label{fig:Rprime-AR}
\end{figure}

\begin{lem}[Labelle] The result of the substitution of $C_R$ in the
  species $S$ of permutations coincides with the species $D_R$ of
  $R$-enriched endofunctions.
\end{lem}

\begin{figure}
  \centering
  \missingfigure{Correspondence of $S(C_R)$ and $D_R$}
  \caption{XXX}
  \label{fig:SCR-DR}
\end{figure}

\begin{proof}
  The lemma states that $S(C_R) = D_R$. We use the decomposition of an
  endofunction into permutations and rooted trees as described in
  \pref{ex:endo-perm-of-rooted}. Replace the rooted trees in this
  decomposition by contractions. If we compare, at each point, the
  fiber of the endofunction with the fiber of the contraction
  ``containing'' that point, we realize that they are in bijection
  (they coincide if the point is not periodic). One can then carry the
  $R$-structures along these bijections. This shows that the
  $R$-enriched endofunctions are in canonical bijection with the
  \trans{permutation assemblies}{assembl\'ees permut\'ees} of
  $R$-enriched contractions.
\end{proof}

The proof of the theorem continues by taking the \emph{derivative} of
$F(A_R)$:
\begin{align*}
F(A_R)' &= F'(A_R) A_R' \\
&= F'(A_R) R(A_R) \frac{1}{1 - C_R} \\
&\equiv F'(A_R) R(A_R) D_R.
\end{align*}

\begin{lem}[Labelle, \trans{Repartitioning}{repartage} lemma]
  Let $G$ be any species.  A structure of the species $G(A_R) D_R$ on
  a set $E$ can be interpreted as giving a partition $E = E_1 + E_2$
  whose first part $E_1$ is equipped with a $G$-structure $\gamma$ and
  the second part $E_2$ is equipped with an $R$-enriched function
  $\lambda : E_2 \to E$.
\end{lem}

\begin{proof}
  Let $(F_1, F_2, g, f)$ be a structure of the species $G(A_R) \cdot
  D_R$ on $E$.  We have $E = F_1 + F_2$. We can describe $g$ as a
  forest of $R$-enriched rooted trees where the set of roots is
  equipped with a $G$-structure $\gamma$. Let $E_1$ be the set of
  these roots, and let $E_2$ be its complement. This forest of rooted
  trees, together with the endofunction $f$, defines an R-enriched
  function $\lambda : E_2 \to E$. (See
  \pref{fig:endo-plus-forest-rooted}.) Conversely, starting from $(E_1,
  E_2, \gamma, \lambda)$, we first recover $F_1$ as the set of all
  points in $E$ that are ultimately transformed into $E_1$ by
  $\lambda$. One may complete the proof by meditating on
  \pref{fig:endo-plus-forest-rooted}.
\end{proof}

\begin{figure}
  \centering
  \missingfigure{Endofunction + forest of rooted trees}
  \caption{XXX}
  \label{fig:endo-plus-forest-rooted}
\end{figure}

We now use this lemma to compute the cardinality of $(G(A_R) D_R)
[n]$. \todo{note typo $R_R$} Indeed, the $R$-enriched functions
$\lambda : E_2 \to E$ \emph{coincide} with the $R$-enriched functions
$\lambda : E_2 \to [n]$ in the case where $E = [n]$ (see the note
preceding \pref{ex:vertebrate}). We have therefore
\[ (G(A_R) D_R) [n] = (G \cdot R^n)[n]. \]
Finally, note that we want to calculate $F(A_R) [n]$, and
if $n \geq 1$, we have
\todo{should there be a prime on the first line?}
\begin{align*}
F(A_R)[n] &= F(A_R)[n-1] \\
&\equiv F'(A_R) R(A_R) D_R[n-1] \\
&\equiv (F' R) R^{n-1} [n-1] \\
&= F' R^n [n-1].
\end{align*}
\end{proof}



% XXX SECTION 3. ENUMERATION OF TYPES OF STRUCTURES

% 3.0. In this chapter, we will try to solve the problem of
% enumeration of \emph{types} of structures of a given species $M$. It will suffice
% to calculate, for each $n \in \N$, the cardinality of the set $\pi_0(M[n])$ of the
% orbits of $M [n]$ under the action of $[n]!$. In other words, we want to identify
% the generating series

% \[ \unl M (x) = \sum_{n \geq 0} \Card \pi_0(M[n]) x^n. \]



% It is often impossible to describe $\unl M (x)$ explicitly. However, if
% we have a functional equation, we can calculate the coefficients
% of $\unl M (x)$ by induction. The current (XXX ???) technique for calculating the number of
% isomorphism classes is due to P\'olya. It makes use of a certain
% polynomial indicating \emph{cycles} (Polya [26 XXX]). Instead, we calculate a
% \term{index series} $Z_M$.  We obtain a substitution theorem for the
% index series. This result often allows us to calculate the coefficients
% of $Z_M$ by \emph{induction}. We will follow a path less algebraic and
% more combinatorial than P\'olya. In this way, we hope to show
% the direct link between the problem of enumeration of structures and that of
% enumeration of \emph{types} of structures.

\bibliographystyle{plainnat}
\bibliography{series-formelles}

\end{document}
